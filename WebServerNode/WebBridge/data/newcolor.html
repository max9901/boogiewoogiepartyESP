<!DOCTYPE html>
<html>
    <style>   
    body {
        margin: 0;
    }
    #mainsrc{
        position: fixed;
        width: 100%;
        height: 100%;
    }
    </style>
<body onload="javascript:onload();" style="background-color:black;">
    <div id=mainsrc>
    </div>
</body>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>

//** OBJECTS **//
var ws;                 //websocket object
var Animations = []
var Animation_speed     = 1000;
var BlockAnimation_size = 50;
var rgbw                = [0,255,0,0];
var setstrobohard       = 0;

// Resize screen option!
$(window).bind('resize', function() {   
    console.log("Resize screen");
    element = document.getElementById('mainsrc');
    positionInfo = element.getBoundingClientRect();
    height = positionInfo.height;
    width = positionInfo.width;
    //blocksfunction!!
    for(var i = 0; i< Animations.length; i++){
        Animations[i].build(BlockAnimation_size)
    }
});

//** Manage Strobo capabilities surpasses all animations and strobes the mainsrc! **//
var strobe_hard_interval;
var Strobo_onflag = 1;
function strobohard(){
    if(Strobo_onflag == 0){
        Strobo_onflag = 1;
        document.getElementById("mainsrc").style.display = "block";
    }else{
        Strobo_onflag = 0;
        document.getElementById("mainsrc").style.display = "none";
    }
}


class Block_Animation{
    dom = {}
    rgbw = [0,255,0,0];
    
    //size == channel ??
    constructor(element,size){
        this.dom = document.createElement('div');
        this.dom.className = 'Block_Animation';
        element.appendChild(this.dom);
        this.dom.style.width  =  '100%';
        this.dom.style.height =  '100%';
        this.dom.style.marginLeft   = 'auto';
        this.dom.style.marginRight  = 'auto';
        this.dom.style.marginTop    = 'auto';
        this.dom.style.marginBottom = 'auto';
        this.dom.style.top = 0; 
        this.dom.style.bottom = 0;
        this.dom.style.left = 0;
        this.dom.style.right = 0;
        this.dom.style.display = 'none';
        this.dom.Blocks = [];
        this.build(size)
    }
    
    
    build = function(size){
        //remove the blocks
        for (var i = this.dom.Blocks.length; i > 0 ; i--) {
            this.dom.Blocks[i-1].remove();
            this.dom.Blocks.splice(i-1,1);    
        }
        //Create the blocks
        if(size){
            var w =  $("#mainsrc").width();
            var h =  $("#mainsrc").height();
            var nbW = Math.floor(w/size);
            var nbH = Math.floor(h/size);

            this.dom.style.width  =  size*nbW + 'px';
            this.dom.style.height =  size*nbH + 'px';

            for(var i=0;i<(nbW*nbH);i++){
                var block = {}
                block = document.createElement('div');
                block.className    = 'Animation_block';                
                block.style.width  =  String(size) + 'px'; 
                block.style.height =  String(size) + 'px'; 
                block.style.float  =  'left';
                block.style.webkitTransition = 'background-color 0.2s ease-in';
                block.style.MozTransition    = 'background-color 0.2s ease-in';
                block.style.msTransition     = 'background-color 0.2s ease-in';
                block.style.OTransition      = 'background-color 0.2s ease-in';
                this.dom.appendChild(block);
                this.dom.Blocks.push(block);
            }
        }
        else {
            //todo
            this.dom.style.width  =  '100%';
            this.dom.style.height =  '100%';
            var block = {}
            block = document.createElement('div');
            block.className = 'Animation_block';                
            block.style.width =  '100%'; 
            block.style.height = '100%'; 
            this.dom.appendChild(block);
            this.dom.Blocks.push(block);
        }
    }
    Animation = function(){
        for (var i = this.dom.Blocks.length; i > 0 ; i--) {
            var block = this.dom.Blocks[i-1];
            var saturation = Math.random();
            var r = (saturation * this.rgbw[0]);
            var g = (saturation * this.rgbw[1]);
            var b = (saturation * this.rgbw[2]);
            var w = (saturation * this.rgbw[3]);
            if(w){
                r = (w + this.rgbw[0]/2.56)%256;
                g = (w + this.rgbw[1]/2.56)%256;
                b = (w + this.rgbw[2]/2.56)%256;
            }            
            block.style.backgroundColor = 'rgb('+r+','+g+','+b+')';
        }
    }

    
    set_Channels = function(channels){
        //todo check channels len
        this.rgbw = [channels[0],channels[1],channels[2],channels[3]];
        //do something with speed channels etc etc indelen 
    }

    setAnimotor = function(ClaSS,speed){
        this.dom.style.display = 'block';
        this.animotor =  setInterval(function(){ClaSS.Animation()},speed);
    }
    clearAnimotor = function(){
        this.dom.style.display = 'none';
        clearInterval(this.animotor);
    }
}
class The_Matrix{
    dom = {}  //canvas ?
    rgbw = [0,255,0,0];

    constructor(element){
        this.dom = document.createElement('canvas');
        this.dom.className = 'The_matrix';
        this.dom.style.display = 'block';
        this.element = element;
        element.appendChild(this.dom);
        this.build(null);
    }

    build = function(arg1){
        this.ctx                     = this.dom.getContext('2d');
        this.positionInfo            = this.element.getBoundingClientRect();
        this.dom.width               = this.positionInfo.width;
        this.dom.height              = this.positionInfo.height;
        this.ypos                    = Array(Math.floor(this.positionInfo.width / 20) + 1).fill(0);
        console.log(this.dom.width)
    }

    set_Channels = function(channels){
        //todo check channels len
        this.rgbw = [channels[0],channels[1],channels[2],channels[3]];
        //do something with speed channels etc etc indelen 
    }

    Animation = function(){
        this.ctx.fillStyle = '#0001';
        this.ctx.fillRect(0, 0, this.dom.width, this.dom.height);
        var r = (this.rgbw[0]);
        var g = (this.rgbw[1]);
        var b = (this.rgbw[2]);
        var w = (this.rgbw[3]);
        if(w){
            r = (w + this.rgbw[0]/2.56)%256;
            g = (w + this.rgbw[1]/2.56)%256;
            b = (w + this.rgbw[2]/2.56)%256;
        }         
        this.ctx.fillStyle = 'rgb('+r+','+g+','+b+')';
        this.ctx.font = '15pt monospace';
        this.ypos.forEach((y, ind) => {
            const text = String.fromCharCode(Math.random() * 128);
            const x = ind * 20;
            this.ctx.fillText(text, x, y);
            if (y > 100 + Math.random() * 10000) this.ypos[ind] = 0;
            else this.ypos[ind] = y + 20;
        });
    }

    setAnimotor = function(ClaSS,speed){
        this.dom.style.display = 'block';
        this.animotor =  setInterval(function(){ClaSS.Animation()},speed/8);
    }
    clearAnimotor = function(){
        this.dom.style.display = 'none';
        clearInterval(this.animotor);
    }
}

class P5_test1{



}

Animations.push( new Block_Animation(document.getElementById('mainsrc'),BlockAnimation_size))
Animations.push( new The_Matrix(document.getElementById('mainsrc')))

// Animations[0].setAnimotor(Animations[0],Animation_speed);



//DEBUGGING
$(window).keyup(function(e){
    if     (e.which==82){rgbw = [255,0,0,0];}      //r = RED
    else if(e.which==71){rgbw = [0,255,0,0];}      //g = Green
    else if(e.which==66){rgbw = [0,0,255,0];}      //b = Blue
    else if(e.which==87){rgbw = [0,0,0,255];}      //b = Blue
    else if(e.which==83){
        if(setstrobohard){
            setstrobohard = 0;
        }else{
            setstrobohard = 100;
        }
        clearInterval(strobe_hard_interval);
        document.getElementById("mainsrc").style.display = "block";
        if(setstrobohard > 0){    
            strobe_hard_interval = setInterval(strobohard, (1000)/((setstrobohard) / 2.55));
        }
    }
    else{
        console.log("unknown KEY: " + e.which);
    }
});


//TODO
function start_websocket(){
      ws = new WebSocket('ws://'+document.location.host+'/wsa',['arduino']);
      ws.onopen = function(e){
        console.log("Connected");
      };
      ws.onclose = function(e){
        console.log("Disconnected");
      };
      ws.onerror = function(e){
        console.log("ws error", e);
      };
      ws.onmessage = function(e){
        console.log(e.data);
        var parts = e.data.split('&'); //afvangen niet splitbaar
        for (i = 0; i < parts.length; i++){
            var mes = parts[i].split(',')
            console.log(mes);
            if(mes[0] == '0'){
                setred = parseInt(mes[1]);
            }
            if(mes[0] == '1'){
                setgreen = parseInt(mes[1]);
            }
            
            if(mes[0] == '2'){
                setblue = parseInt(mes[1]);
            }

            if(mes[0] == '3'){
                setwhite = parseInt(mes[1]);
            }
            
            if(mes[0] == '4'){
                setstrobohard = parseInt(mes[1]);
                clearInterval(strobe_hard_interval);
                document.getElementById("mainsrc").style.display = "block";
                if(setstrobohard > 0){    
                    strobe_hard_interval = setInterval(strobohard, (1000)/((setstrobohard) / 2.55));
                }
            }
            //fixen JA
            if(mes[0] == 'O'){
                setsize = parseInt(mes[1]);
                $('.Blocks_animation').remove();
                build(setsize);
            }
            if(mes[0] == 'I'){
                Animation_speed = parseInt(mes[1]);
                clearInterval(si);
                if(Animation_speed > 0){    
                    si = setInterval(Blocks_animation, ((100000)/(Animation_speed) / 2.55));
                }
            }
        }
        hexrgb = fullColorHex(setred,setgreen,setblue);
      };
    
}
//** ONLOAD FUNCTION **//
function onload(){
    start_websocket();
}

</script>
</html>